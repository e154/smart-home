FROM postgres:15 as postgres
MAINTAINER Filippov Alex <support@e154.ru>

FROM debian:12-slim
RUN apt-get update \
    && apt-get install -y --no-install-recommends libpq5 ca-certificates iputils-ping
RUN update-ca-certificates
COPY --from=postgres /usr/lib/postgresql/15/bin/pg_dump /usr/local/bin
COPY --from=postgres /usr/lib/postgresql/15/bin/pg_restore /usr/local/bin
ENTRYPOINT ["/server"]
USER nobody
ADD . /

EXPOSE 3000
EXPOSE 3001
EXPOSE 3002
EXPOSE 3003
EXPOSE 1883
EXPOSE 8080
EXPOSE 8443

ENV PG_USER="smart_home"
ENV PG_PASS="smart_home"
ENV PG_HOST="postgres"
ENV PG_NAME="smart_home"
ENV PG_PORT="5432"
ENV PG_DEBUG="false"
ENV PG_MAX_IDLE_CONNS="10"
ENV PG_MAX_OPEN_CONNS="50"
ENV PG_CONN_MAX_LIFE_TIME="30"
ENV AUTO_MIGRATE="true"
ENV SNAPSHOT_DIR=""
ENV MODE="release"
ENV MQTT_PORT="1883"
ENV MQTT_RETRY_INTERVAL="20"
ENV MQTT_RETRY_CHECK_INTERVAL="20"
ENV MQTT_SESSION_EXPIRY_INTERVAL="0"
ENV MQTT_SESSION_EXPIRE_CHECK_INTERVAL="0"
ENV MQTT_QUEUE_QOS_0_MESSAGES="true"
ENV MQTT_MAX_INFLIGHT="32"
ENV MQTT_MAX_AWAIT_REL="100"
ENV MQTT_MAX_MSG_QUEUE="1000"
ENV MQTT_DELIVER_MODE="1"
ENV LOGGING="true"
ENV COLORED_LOGGING="false"
ENV ALEXA_HOST=""
ENV ALEXA_PORT="3003"
ENV MOBILE_HOST=""
ENV MOBILE_PORT="3002"
ENV API_HTTP_PORT="3001"
ENV API_SWAGGER="true"
ENV API_GZIP="false"
ENV LANG="EN"
ENV ROOT_MODE="false"
ENV DOMAIN="localhost"
ENV PPROF="false"
ENV HTTPS="false"
ENV ROOT_SECRET=""

ENV GATE_API_HTTP_PORT="8080"
ENV GATE_API_HTTPS_PORT="8443"
ENV GATE_API_DEBUG="false"
ENV GATE_API_GZIP="true"
ENV GATE_DOMAIN="localhost"
ENV GATE_PPROF="false"
ENV GATE_HTTPS="false"
ENV GATE_PROXY_TIMEOUT="5"
ENV GATE_PROXY_IDLE_TIMEOUT="10"
ENV GATE_PROXY_SECRET_KEY=""

VOLUME $APP_DIR/snapshots
VOLUME $APP_DIR/data
VOLUME $APP_DIR/conf
